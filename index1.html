<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Human Runner â€“ Mini Militia Edition</title>

<style>
body {
  margin: 0;
  background: #111;
  overflow: hidden;
  touch-action: none;
  font-family: Arial;
  color:white;
}

#top {
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
}

canvas {
  background:#000;
  display:block;
}

.joystick {
  position:fixed;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,0.08);
}

.knob {
  position:absolute;
  width:50px;
  height:50px;
  border-radius:50%;
  background:rgba(255,255,255,0.4);
  left:35px;
  top:35px;
}

#leftJoy { bottom:40px; left:40px; }
#rightJoy { bottom:40px; right:40px; }

#fireBtn{
  position:fixed;
  right:60px;
  bottom:190px;
  width:80px;
  height:80px;
  border-radius:50%;
  border:none;
  background:crimson;
  color:white;
  font-size:18px;
}
</style>
</head>

<body>

<div id="top">
Score: <span id="score">0</span> |
Health: <span id="health">10</span> |
Fuel: <span id="fuel">100</span>
</div>

<canvas id="game"></canvas>

<div id="leftJoy" class="joystick"><div class="knob"></div></div>
<div id="rightJoy" class="joystick"><div class="knob"></div></div>
<button id="fireBtn">FIRE</button>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight*0.75;
}
resize();
addEventListener("resize",resize);

const TILE=40;
const scoreEl=document.getElementById("score");
const healthEl=document.getElementById("health");
const fuelEl=document.getElementById("fuel");

/* ===== ORIGINAL MAP (UNCHANGED) ===== */
const map=[
"000000000000000000000000000000000000",
"000000000000000000000000000000000000",
"000000000001111111111100000000000000",
"000000000000000000000000000000000000",
"000001111100000000000000111110000000",
"000001000100000000000000100010000000",
"000001000100000000000000100010000000",
"111111000111110000000011111000111111",
"000000000000000000000000000000000000",
"000000000000111111111100000000000000",
"000000000000000000000000000000000000",
"000011111000000000000000001111100000",
"000010001000000000000000001000100000",
"000010001000000000000000001000100000",
"111110001111111000000111111000111111",
"000000000000000000000000000000000000",
"000000000000000000000000000000000000",
"111111111111111111111111111111111111"
];

function isSolid(col,row){
  if(row<0||row>=map.length) return true;
  if(col<0||col>=map[0].length) return true;
  return map[row][col]==="1";
}

/* ===== PLAYER ===== */
const player={
  x:200,y:200,
  w:26,h:36,
  vx:0,vy:0,
  speed:4,
  jump:-12,
  onGround:false,
  health:10,
  fuel:100,
  maxFuel:100,
  angle:0
};

let cameraX=0;
let bullets=[];
let enemyBullets=[];
let machine=spawnMachine();
let machineHits=0;
let score=0;
let gameOver=false;
let healthBox=null;

const GRAVITY=0.6;
const FRICTION=0.8;

/* ===== MACHINE SPAWN ===== */
function spawnMachine(){
  while(true){
    const c=Math.floor(Math.random()*map[0].length);
    const r=Math.floor(Math.random()*map.length);
    if(map[r][c]==="0"){
      return{
        x:c*TILE+TILE/2,
        y:r*TILE+TILE/2,
        fireCooldown:0
      };
    }
  }
}

/* ===== HEALTH BOX ===== */
function spawnHealthBox(){
  while(true){
    const c=Math.floor(Math.random()*map[0].length);
    const r=Math.floor(Math.random()*map.length);
    if(map[r][c]==="0"){
      healthBox={
        x:c*TILE+TILE/2,
        y:r*TILE+TILE/2
      };
      return;
    }
  }
}
setInterval(spawnHealthBox,8000);

/* ===== JOYSTICKS ===== */
function createJoystick(el){
  const knob=el.querySelector(".knob");
  let dx=0,dy=0,active=false;

  el.addEventListener("touchstart",()=>active=true);

  el.addEventListener("touchmove",e=>{
    if(!active)return;
    const rect=el.getBoundingClientRect();
    dx=e.touches[0].clientX-(rect.left+60);
    dy=e.touches[0].clientY-(rect.top+60);
    const dist=Math.hypot(dx,dy);
    if(dist>40){ dx=dx/dist*40; dy=dy/dist*40; }
    knob.style.left=35+dx+"px";
    knob.style.top=35+dy+"px";
  });

  el.addEventListener("touchend",()=>{
    active=false; dx=0; dy=0;
    knob.style.left="35px";
    knob.style.top="35px";
  });

  return()=>({x:dx/40,y:dy/40});
}

const leftInput=createJoystick(document.getElementById("leftJoy"));
const rightInput=createJoystick(document.getElementById("rightJoy"));

document.getElementById("fireBtn").ontouchstart=()=>fireBullet();

/* ===== FIRE ===== */
function fireBullet(){
  bullets.push({
    x:player.x+player.w/2,
    y:player.y+player.h/2,
    vx:Math.cos(player.angle)*8,
    vy:Math.sin(player.angle)*8
  });
}

/* ===== COLLISION ===== */
function horizontalCollision(){
  player.x+=player.vx;
  let left=Math.floor(player.x/TILE);
  let right=Math.floor((player.x+player.w)/TILE);
  let top=Math.floor(player.y/TILE);
  let bottom=Math.floor((player.y+player.h-1)/TILE);

  if(player.vx>0&&(isSolid(right,top)||isSolid(right,bottom))){
    player.x=right*TILE-player.w;
    player.vx=0;
  }
  if(player.vx<0&&(isSolid(left,top)||isSolid(left,bottom))){
    player.x=(left+1)*TILE;
    player.vx=0;
  }
}

function verticalCollision(){
  player.y+=player.vy;
  let left=Math.floor(player.x/TILE);
  let right=Math.floor((player.x+player.w-1)/TILE);
  let top=Math.floor(player.y/TILE);
  let bottom=Math.floor((player.y+player.h)/TILE);

  if(player.vy>0&&(isSolid(left,bottom)||isSolid(right,bottom))){
    player.y=bottom*TILE-player.h;
    player.vy=0;
    player.onGround=true;
  } else if(player.vy>0){
    player.onGround=false;
  }

  if(player.vy<0&&(isSolid(left,top)||isSolid(right,top))){
    player.y=(top+1)*TILE;
    player.vy=0;
  }
}

function bulletHitsWall(x,y){
  const col=Math.floor(x/TILE);
  const row=Math.floor(y/TILE);
  return isSolid(col,row);
}

/* ===== UPDATE ===== */
function update(){
  if(gameOver)return;

  const left=leftInput();
  const right=rightInput();

  player.vx=left.x*player.speed;

  if(left.y<-0.3 && player.fuel>0){
    player.vy+=left.y*0.6;
    player.fuel-=0.7;
  } else {
    player.fuel+=0.3;
  }

  if(player.fuel>player.maxFuel)player.fuel=player.maxFuel;
  if(player.fuel<0)player.fuel=0;

  player.vy+=GRAVITY;
  player.vx*=FRICTION;

  horizontalCollision();
  verticalCollision();

  player.angle=Math.atan2(right.y,right.x);

  updateCamera();
  updateBullets();
  updateEnemyBullets();
  updateHealthBox();

  fuelEl.textContent=Math.floor(player.fuel);
  healthEl.textContent=player.health;
}

function updateCamera(){
  cameraX=player.x-canvas.width/2;
  if(cameraX<0)cameraX=0;
  let max=map[0].length*TILE-canvas.width;
  if(cameraX>max)cameraX=max;
}

/* ===== BULLETS ===== */
function updateBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i];
    b.x+=b.vx; b.y+=b.vy;

    if(bulletHitsWall(b.x,b.y)){ bullets.splice(i,1); continue; }

    if(Math.hypot(b.x-machine.x,b.y-machine.y)<20){
      bullets.splice(i,1);
      machineHits++;
      if(machineHits>=10){
        score++; scoreEl.textContent=score;
        machine=spawnMachine();
        machineHits=0;
      }
    }
  }
}

function updateEnemyBullets(){
  machine.fireCooldown--;
  if(machine.fireCooldown<=0){
    const angle=Math.atan2(player.y-machine.y,player.x-machine.x);
    enemyBullets.push({
      x:machine.x,y:machine.y,
      vx:Math.cos(angle)*3,
      vy:Math.sin(angle)*3
    });
    machine.fireCooldown=120;
  }

  for(let i=enemyBullets.length-1;i>=0;i--){
    let b=enemyBullets[i];
    b.x+=b.vx; b.y+=b.vy;

    if(bulletHitsWall(b.x,b.y)){ enemyBullets.splice(i,1); continue; }

    if(Math.hypot(b.x-(player.x+13),b.y-(player.y+18))<15){
      enemyBullets.splice(i,1);
      player.health--;
      if(player.health<=0)gameOver=true;
    }
  }
}

function updateHealthBox(){
  if(!healthBox)return;
  if(Math.hypot(player.x-healthBox.x,player.y-healthBox.y)<25){
    player.health=10;
    healthBox=null;
  }
}

/* ===== DRAW ===== */
function drawMap(){
  for(let r=0;r<map.length;r++){
    for(let c=0;c<map[r].length;c++){
      if(map[r][c]==="1"){
        ctx.fillStyle="#444";
        ctx.fillRect(c*TILE-cameraX,r*TILE,TILE,TILE);
      }
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();

  ctx.fillStyle="red";
  ctx.fillRect(machine.x-15-cameraX,machine.y-15,30,30);

  if(healthBox){
    ctx.fillStyle="yellow";
    ctx.fillRect(healthBox.x-12-cameraX,healthBox.y-12,24,24);
  }

  // Player rotated gun
  ctx.save();
  ctx.translate(player.x+13-cameraX,player.y+18);
  ctx.rotate(player.angle);
  ctx.fillStyle="#2ecc71";
  ctx.fillRect(-13,-18,26,36);
  ctx.restore();

  // Jetpack flame
  if(leftInput().y<-0.3 && player.fuel>0){
    ctx.fillStyle="orange";
    ctx.beginPath();
    ctx.arc(player.x+13-cameraX,player.y+40,8,0,Math.PI*2);
    ctx.fill();
  }

  ctx.fillStyle="yellow";
  bullets.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x-cameraX,b.y,4,0,Math.PI*2);
    ctx.fill();
  });

  ctx.fillStyle="orange";
  enemyBullets.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x-cameraX,b.y,5,0,Math.PI*2);
    ctx.fill();
  });

  if(gameOver){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("GAME OVER",canvas.width/2-120,canvas.height/2);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
